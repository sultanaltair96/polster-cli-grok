# Polster CI/CD Pipeline for Azure DevOps
# This pipeline automates data materialization and commits changes back to the repository

# Trigger on push to master
trigger:
  branches:
    include:
      - master

# Scheduled runs (UTC!)
schedules:
- cron: "0 0 * * *"
  displayName: Asset materialization daily at midnight UTC
  branches:
    include:
      - master
  always: true

pool:
  vmImage: ubuntu-latest

variables:
  PYTHON_VERSION: '3.12'

steps:
# 0. Checkout repository
- checkout: self
  persistCredentials: true
  fetchDepth: 0

# 1. FORCE latest master (critical for scheduled runs)
- script: |
    echo "Forcing workspace to latest origin/master"
    git fetch origin master
    git checkout master || git checkout -b master
    git reset --hard origin/master

    echo "Running commit:"
    git log -1 --oneline
  displayName: 'Force latest master'

# 2. Use Python
- task: UsePythonVersion@0
  inputs:
    versionSpec: $(PYTHON_VERSION)
  displayName: 'Use Python $(PYTHON_VERSION)'

# 3. Install uv
- script: |
    python -m pip install --upgrade pip
    pip install uv
  displayName: 'Install uv'

# 4. Create venv + install dependencies
- script: |
    uv venv .venv
    source .venv/bin/activate
    pip install --upgrade pip
    uv sync
  displayName: 'Create venv and install dependencies'

# 5. Run Polster materialization
- script: |
    source .venv/bin/activate
    python run_polster.py
  displayName: 'Run run_polster.py'

# 6. Commit and push changes (if any)
- script: |
    git config user.email "pipeline@azuredevops.local"
    git config user.name "Azure DevOps Pipeline"

    git status
    git add data/ .dagster/

    if git diff --cached --quiet; then
      echo "No changes to commit"
    else
      git commit -m "Automated commit from pipeline [skip ci]"

      # Rebase-safe pull, fallback to merge
      git pull --rebase origin master || {
        echo "Rebase failed, falling back to merge"
        git rebase --abort
        git pull origin master --no-rebase
      }

      git push origin master
    fi
  displayName: 'Commit and push changes'